
@{
    ViewBag.Title = "招标详情";
}



<link rel="stylesheet" href="~/css/icheck/minimal/minimal.css" />
<link rel="stylesheet" href="~/css/style.css" />
<link href="~/css/sweetalert2.css" rel="stylesheet" />
<style>

    .meet-form.meet-form7 .form-tr .blue-word{
        color:#008cd6;
    }
   .meet-form.meet-form7 .form-tr td:nth-child(2){
       color:#3e3a39
    }
        .submenu {
        display: none;
        font-size: 14px;
    }

        .submenu dl {
            background: #f2f2f2;
            padding: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }

            .submenu dl dt {
                width: 120px;
                float: left;
                line-height: 100%;
                height: 100%;
                color: #999;
            }

            .submenu dl dd {
                margin-left: 80px;
                line-height: 24px;
                text-align: justify;
            }
                .canvas {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, .6);
        z-index: 9999;
        display: none;
    }

        .canvas .canvas_content {
            width: 790px;
            height: 530px;
            background: #fff;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            margin: auto;
            border: 1px solid #008cd6;
        }

        .canvas h3 {
            height: 45px;
            padding-left: 20px;
            background: #eaf6fd;
            line-height: 45px;
            font-size: 18px;
            font-weight: normal;
            color: #008cd6;
        }

        .canvas .canvas_close {
            display: inline-block;
            width: 35px;
            height: 35px;
            font-size: 30px;
            color: #008cd6;
            top: 0;
            text-align: center;
            cursor: pointer;
            position: absolute;
            right: 10px;
        }

    .canvas_content_text {
        width: 100%;
        height: 50%;
        margin-top: 35px;
    }

        .canvas_content_text ul li {
            padding: 5px 10px;
            margin-left: 40px;
            color: #999;
            position: relative;
        }

            .canvas_content_text ul li ul li {
                margin-left: 90px;
            }

            .canvas_content_text ul li textarea {
                height: 185px;
                border-radius: 5px;
                border: 1px solid #d7d7d7;
                width: 585px;
                resize: none;
                margin-left: 10px;
                padding: 10px;
                line-height: 20px;
                text-align: justify;
            }

            .canvas_content_text ul li input[type="text"] {
                -web-kit-appearance: none;
                -moz-appearance: none;
                width: 120px;
                height: 25px;
                border: 1px solid #c8cccf;
                border-radius: 5px;
                color: #6a6f77;
                outline: 0;
                padding-left: 5px;
            }

                .canvas_content_text ul li input[type="text"].input3 {
                    width: 50px;
                }

            .canvas_content_text ul li i {
                color: #ff0000;
                line-height: 25px;
                padding-right: 5px;
                vertical-align: middle;
                display: inline-block;
                font-style: normal;
            }

            .canvas_content_text ul li span {
                display: inline-block;
                width: 80px;
                text-align: left;
                float: left
            }

            .canvas_content_text ul li .upload {
                position: relative;
                display: inline-block;
                text-align: center;
                color: #ffffff;
                width: 70px;
                height: 30px;
                line-height: 30px;
                background-color: #008bd6;
                border-radius: 3px;
            }

                .canvas_content_text ul li .upload input[type="text"] {
                    opacity: 0;
                    position: absolute;
                    left: 0;
                }

    .canvas_btn {
        text-align: center;
        padding-top: 100px;
    }

    .canvas-fj {
        padding-left: 5px;
        display: inline-block;
        font-size: 14px;
        color: #bfbdba;
    }
    #bidapplylayer .canvas_close{
        background:transparent;
    }
    #bidapplylayer .canvas_content {
        width: 500px;
        height: 300px;
    }
   #bidapplylayer .canvas_content_text {
        height: auto;
    }
   #bidapplylayer .canvas_btn{
       padding-top:20px;
   }
    .meet-form7 .form-tr .form-lable {
        width: 120px;
    }
</style>
<div class="left-nav">
    <div class="left-nav-con">
        <h1>招标内容</h1>
        <ul class="left-nav-list">
            <li><a href="/Projects" class="active"><i class="icon icon-eye1"></i>内容列表</a></li>
        </ul>
    </div>
</div>
<div class="main-con">
    <div class="main-wrap">
        <div class="main-top">
            <span class="js-page-name">招标详情</span>
            <div class="apply-opt">
                <a href="javascript:;" class="js-cancle-meet chehui" title="撤回" onclick="drawback()" hidden>
                    <i class="meet-icon icon-cancel">撤回</i>
                </a>
                @Html.Raw(ViewBag.moretime)
                <a href='#' class='js-cancle-meet' title='导出' id="exportbtn" onclick="printDiv()" hidden>
                    <i class='meet-icon icon-cancel icon-dc'>导出</i>
                </a>
                <a href="#" class="js-cancle-meet" onclick="window.history.go(-1)" title="返回">
                    <i class="meet-icon icon-del icon-tb">返回</i>
                </a>
            </div>
        </div>

        <!--招标申请 -->
        <div class="canvas" id="bidapplylayer">
            <div class="canvas_content">
                <span class="canvas_close">×</span>
                <h3>招标申请</h3>
                <div class="canvas_content_text">

                    <ul>
                        <li><i>*</i><span style="width:auto">报名截止时间：</span><input id="applydate" type="text" name="" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'',maxDate:''})"></li>
                        <li><i>*</i><span style="width:auto">预计开标时间：</span><input id="opendate" type="text" name="" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'',maxDate:''})"></li>
                        <li><i>*</i><span style="width:auto">拟中标单位数量：</span><input id="bidingnum" type="text" name="" class="input3"></li>
                    </ul>
                </div>
                <div class="canvas_btn">
                    <a href="#" class="meet-btn big-btn lightblue-btn subm" onclick="bidSubmit(1)">提交</a>
                    <a href="#" class="meet-btn big-btn gray-btn">返回</a>
                </div>
            </div>
        </div>

        <div class="wc-container">
            <div class="wc-nav">
            </div>
            <div class="detail-wrap detail-con">
                <div class="block-left block-left2 block-left4" id="printArea">
                    @*<div class="detail-fb">
            提交人：<span>@ViewBag.Publisher</span>发布时间：<span>@ViewBag.PublishDate</span>
        </div>*@
                    <table class="meet-form meet-form7">
                        <tbody>
                            <tr class="form-tr form-tr-title-bg">
                                <td class="blue-word form-lable">项目名称：</td>
                                <td>@ViewBag.Name</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">提交人：</td>
                                <td>@ViewBag.Publisher</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">项目地点：</td>
                                <td>@ViewBag.Location</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">项目类型：</td>
                                <td>@ViewBag.Type</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">报名截止时间：</td>
                                <td>@ViewBag.ApplyDate</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">预计开标时间：</td>
                                <td>@ViewBag.OpenDate</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">拟中标单位数量：</td>
                                <td>@ViewBag.BidingNum</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">招标内容介绍：</td>
                                <td>@Html.Raw(ViewBag.ProDescription)</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">招标文件简述：</td>
                                <td>@Html.Raw(ViewBag.Content)</td>
                            </tr>
                            <tr class="form-tr">
                                <td class="blue-word form-lable">招标文件：</td>
                                <td><ul id="bffiles"></ul></td>
                            </tr>
                            @Html.Raw(ViewBag.comjion)
                            @Html.Raw(ViewBag.ResponseCompanysHtml)
                            @Html.Raw(ViewBag.CompanysPrint)
                        </tbody>
                    </table>
                    <div class="meet-form meet-form8" style="border:0px;margin-top:28px" id="procs" hidden>
                        <span style="text-align:center;font-size:24px;color:deepskyblue;">审批记录</span>
                        <table class="meet-form meet-form8" id="printTab"></table>
                    </div>
                </div>
                <div class="block-right block-right2">
                    <div class="block-right-wrap">
                        <div class="block-rigt">
                            <div class="detail-user2">
                                <a class="meet-btn2 medium-btn">审核意见</a>
                                <a class="meet-btn2 medium-btn active">流转信息</a>
                            </div>
                            <div class="detail-user-list2 right-ss"
                                 style="min-height:215px;overflow: auto;">
                                <div class="meet-user-span2" style="display: none;">
                                    <div class="feedback-con feedback-con2">
                                        <div class="feedback-item decfeedback-item">
                                            <div class="feedback-item-title">
                                                <i class="meet-icon icon-message-on"></i>
                                                驳回理由
                                            </div>
                                            <ul class="feedback-list feedback-admin">
                                                <li id="declineInfo"></li>
                                            </ul>
                                        </div>
                                        <div class="feedback-item js-myattend">
                                            <div class="feedback-item-title">
                                                <i class="meet-icon icon-message"></i>
                                                共<span class="js-feed-count"></span>条回复消息
                                            </div>
                                            <ul class="feedback-list feedback-users">
                                                <li id="passlineInfo"></li>
                                            </ul>
                                        </div>

                                    </div>
                                </div>
                                <div id="transferInfo" class="meet-user-span2" style="display: block;"></div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<script type="text/javascript" src="~/js/jquery-1.11.0.js"></script>
<script type="text/javascript" src="~/js/jquery-ui.min.js"></script>
<script type="text/javascript" src="~/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="~/js/validate/jquery.validate.min.js"></script>
<script type="text/javascript" src="~/js/validate/messages_zh.min.js"></script>
<script type="text/javascript" src="~/js/icheck/icheck.min.js"></script>
<script type="text/javascript" src="~/js/js.js"></script>
<script src="~/Scripts/jquery.form.js"></script>
<script src="~/js/sweetalert2.all.js"></script>

<script>
        var status = getQueryString('status');
    if (status == "0")
        $(".chehui").hide();
    else {
        $.post('/Common/GetDrawbackStatus_submiter', { objid: @ViewBag.pid, appid: 3 }, function (res) {
            if (res == "yes")
                $(".chehui").show();
            else
                $(".chehui").hide();
        });
    }
    function drawback() {
        $.post('/Common/Drawback_submiter', { objid: @ViewBag.pid, appid: 3 }, function (res) {
            window.location.assign('/Projects/Detail?pid=@ViewBag.pid')
        });
    }

    function printDiv() {
        $('#procs').show();
        $('#print-tr1').show();
        $('#print-tr2').show();
        $('#print-tr3').show();
        $('#print-tr4').show();
        $('#hide_tr1').hide();
        $('#hide_tr2').hide();
        var printData = document.getElementById("printArea").innerHTML;
        var oldstr = document.body.innerHTML;
        document.body.innerHTML = printData;
        window.print();
        document.body.innerHTML = oldstr;   //保持原页面格式
        $('#procs').hide();
        $('#print-tr1').hide();
        $('#print-tr2').hide();
        $('#print-tr3').hide();
        $('#print-tr4').hide();
        $('#hide_tr1').show();
        $('#hide_tr2').show();
    }
    //分页
    function pages(cur, totalPage, totalRows, setNum) {
        if (!totalPage) return false;
        var url = window.location.href;
        var url_arr = url.split("?");
        var url = url_arr[0];
        var htm = '<a data-cur="1" class="js-page-num page-num" style="margin-left:5px;">《</a>' +
            '<a class="js-page-num page-num num-left" data-cur="' + (cur > 1 ? (cur - 1) : 1) + '">&lt;</a>';
        if (totalPage != 1) {
            htm += '<a data-cur="' + ((cur + 1) > totalPage ? (cur - 1) : cur) + '" class="js-page-num page-num ' + (((cur + 1) > totalPage ? (cur - 1) : cur) == cur ? "active" : "") + '">' + ((cur + 1) > totalPage ? (cur - 1) : cur) + '</a>';
        }

        htm += '<a data-cur="' + ((cur + 1) > totalPage ? totalPage : (cur + 1)) + '" class="js-page-num page-num ' + (((cur + 1) > totalPage ? totalPage : (cur + 1)) == cur ? "active" : "") + '">' + ((cur + 1) > totalPage ? totalPage : (cur + 1)) + '</a>' +
            '<a class="js-page-num num-right page-num" data-cur="' + (cur < totalPage ? (cur + 1) : totalPage) + '">&gt;</a>' +
            '<a data-cur="' + totalPage + '" class="js-page-num page-num">》</a>' +
            '<a class="page-num page-input"><input type="text" value=""/></a>' +
            '<a class="js-page-num page-num num-go active" data-cur="' + ((cur + 2) > totalPage ? cur : (cur + 2)) + '">GO</a>';
        $(".page").append(htm);

        //分页点击
        $(".page>a.js-page-num").on("click", function () {
            var url = window.location.href;
            var cur_num = $(this).data("cur");
            if ($(this).hasClass("num-go")) {
                cur_num = ($(".page-input input").val() ? $(".page-input input").val() : 1);
            }
            if (url.indexOf("?") == -1) {
                url += "?";
            }
            if (!$.getUrlParam("curPage")) {
                url = url + '&curPage=' + cur_num;
                $(this).attr("href", url);
            } else {
                replaceParamVal("curPage", cur_num);
            }
        });

        $(".page-sel").change(function () {
            var url = window.location.href;
            var page_len = $(this).val();
            if (url.indexOf("?") == -1) {
                url += "?";
            }
            if (!$.getUrlParam("Length")) {
                url = url + '&Length=' + page_len;
                window.location.href = url;
            } else {
                replaceParamValNo("curPage", 1);
                replaceParamVal("Length", page_len);
            }
        });

    }

    $.get("/Projects/GetFiles?pid=@ViewBag.pid&ftype=2", function (data) {          
            var obj = JSON.parse(data);
            for (var i = 0; i < obj.length; i++) {
                var li = document.createElement('li');   
                var yulan = "";
                if (obj[i].FileName.indexOf('.DOC') != -1 || obj[i].FileName.indexOf('.doc') != -1 || obj[i].FileName.indexOf('.pdf') != -1)
                    yulan = '<a href="/pdfViewer.html?file=' + obj[i].FilePath.replace('../projectFiles\\', 'http://cr16gd.saibo.net.cn/projectFiles/') + '" style = "color:#008cd6;margin-left: 5px;" target="_blank">预览</a>&nbsp;&nbsp;';
                li.innerHTML = '<span style = "color:#3e3a39;margin-left: 5px;" >' + obj[i].FileName +yulan+ '<a href = "'+obj[i].FilePath+'" style = "color:#008cd6;margin-left: 5px;" target="_blank">下载</a><span>';
                document.getElementById("bffiles").appendChild(li)
            }
    });
    $.get("/Common/GetApproveProcessingInfo", { oid: @ViewBag.pid, apid: "3"}, function (data) {
        var obj = JSON.parse(data);
        if(obj.length==0)
            return;
        var pdepart = obj[0].pname;
        var printPro = '<tr><td colspan = "5">' + pdepart + '</td ></tr>';
        var dechtm = "";
        var passhtm = "";
        var htm = '<h4 class="cp01"><span></span>' + pdepart + '</h4><ul>';//<li><span class="yj06">' + obj[0].name + '</span> <span class="yj02">' + obj[0].username + '</span> <span class="yj03">' + obj[0].dd +'</span> <span class="yj04">提交申请</span></li >';
        var hstyle = 'cp01'; //cp02
        var ulstyle= 'uc01'; //uc02
        for (var i = 0; i < obj.length; i++) {
            var o = obj[i];
            if(i==0){
                htm += '<li class="li-blue2"><div style="clear:both"><span class="yj06">' + o.name + '</span> <span class="yj02">' + o.username + '</span> <span class="yj03">' + o.dd + '</span> <span class="yj04">提交申请</span></div></li >'
                printPro += '<tr><td width="20%" style="border:0px;text-align:center;vertical-align:central">' + o.name + '</td>' +
                    '<td width = "12%" style = "border:0px;text-align:center;vertical-align:central">' + o.username + '</td>' +
                    '<td width="25%" style="border:0px;text-align:center;vertical-align:central">' + o.dd + '</td>' +
                    '<td width="12%" style="border:0px;text-align:center;vertical-align:central"><span style="color:deepskyblue">提交申请</span></td>' +
                    '<td width="30%" style="border:0px;text-align:center;padding:0px;vertical-align:central"><img src="/sigs/' + o.sigfile + '" style="height:80px;width:150px; margin:0px"></td></tr>';
                continue;
            }
            printPro += '<tr><td width="20%" style="border:0px;text-align:center;vertical-align:central">' + o.name + '</td>' +
                '<td width = "12%" style = "border:0px;text-align:center;vertical-align:central">' + o.username + '</td>' +
                '<td width="25%" style="border:0px;text-align:center;vertical-align:central">' + o.dd + '</td>' +
                '<td width="12%" style="border:0px;text-align:center;vertical-align:central"><span style="color:deepskyblue">同意</span></td>' +
                '<td width="30%" style="border:0px;text-align:center;padding:0px;vertical-align:central"><img src="/sigs/' + o.sigfile + '" style="height:80px;width:150px; margin:0px"></td></tr>';
            if (o.pname == pdepart) {
                if (o.approved == 2) {
                    if(o.comment!=""){
                        passhtm += '<h3>' + o.name + ' <i>' + o.username + '</i> <span>' + o.dd + '</span></h3><p class="passbjg"  id="comlenght" > '+ o.comment + '</p >'
                    }
                    htm += '<li class="li-blue2"><div style="clear:both"><span class="yj06">' + o.name + '</span> <span class="yj02">' + o.username + '</span> <span class="yj03">' + o.dd + '</span> <span class="yj04">同意</span></div></li >'
                }
                else if (o.approved == 3) {
                    dechtm = '<h3>' + o.name + ' <i>' + o.username + '</i> <span>' + o.dd + '</span></h3><p class="bjg" > '+ o.comment + '</p >'+dechtm
                    hstyle = 'cp02'
                    ulstyle = 'uc02'
                    htm += '<li ><div style="clear:both"><span class="yj06">' + o.name + '</span> <span class="yj02">' + o.username + '</span> <span class="yj03">' + o.dd + '</span> <span class="yj05">驳回</span></div></li >'
                } else {
                    hstyle = 'cp02'
                    ulstyle = 'uc02'
                    htm += '<li><div style="clear:both"><span class="yj06">' + o.name + '</span> <span class="yj02">' + o.username + '</span></div></li >'
                }
            }
            else {
                htm += '</ul>';
                pdepart = o.pname;
                htm += '<h4 class="' + hstyle + '"><span></span>' + pdepart + '</h4>';
                if (o.approved == 2) {
                    if(o.comment!=""){
                        passhtm += '<h3>' + o.name + ' <i>' + o.username + '</i> <span>' + o.dd + '</span></h3><p class="passbjg" id="comlenght" > '+ o.comment + '</p >'
                    }
                    htm += '<ul class="' + ulstyle + '"><li class="li-blue2"><div style="clear:both"><span class="yj06">' + o.name + '</span> <span class="yj02">' + o.username + '</span> <span class="yj03">' + o.dd + '</span> <span class="yj04">同意</span></div></li >'
                }
                else if (o.approved == 3) {
                    dechtm += '<h3>' + o.name + ' <i>' + o.username + '</i> <span>' + o.dd + '</span></h3><p class="bjg" > '+ o.comment + '</p >'
                    hstyle = 'cp02'
                    ulstyle = 'uc02'
                    htm += '<ul class="' + ulstyle + '"><li><div style="clear:both"><span class="yj06">' + o.name + '</span> <span class="yj02">' + o.username + '</span> <span class="yj03">' + o.dd + '</span> <span class="yj05">驳回</span></div></li >'
                } else {
                    hstyle = 'cp02'
                    ulstyle = 'uc02'
                    htm += '<ul class="' + ulstyle + '"><li><div style="clear:both"><span class="yj06">' + o.name + '</span> <span class="yj02">' + o.username + '</span></div></li >'
                }
            }
        }
        $('#printTab').html(printPro)
        htm += '</ul><h4 class="' + hstyle + '"><span></span>结束</h4>';
        $("#transferInfo").html(htm);
        $("#declineInfo").html(dechtm);
        $("#passlineInfo").html(passhtm);
        var comlenght = $('#passlineInfo').children('p').length
        $(".js-feed-count").html(comlenght);

        if ($("#passlineInfo").html() == "") {
            $(".feedback-item.js-myattend").hide()
        } else {
            $(".feedback-item.js-myattend").show()
        }

        if ($("#declineInfo").html() == "") {
            $(".feedback-item.decfeedback-item").hide()
        } else {
            $(".feedback-item.decfeedback-item").show()
        }
    })
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg); //获取url中"?"符后的字符串并正则匹配
        var context = "";
        if (r != null)
            context = r[2];
        reg = null;
        r = null;
        return context == null || context == "" || context == "undefined" ? "" : context;
    }
    
    $(function () {
        var status = getQueryString('status');
        if (status != "2") {
            $('#exportbtn').hide()
        }
        else {
            $('#exportbtn').show()
        }
        $("#bfup").change(function () {
            if($("#bfup").val()==""){
                return;
            }
            $("#bfupform").ajaxSubmit(function (res) {

                var names = res.split('|')
                var li = document.createElement("li");
                li.id = names[0].trim()
                li.innerHTML = names[1] + '<a href = "#" style = "color: #008cd6;margin-left: 5px;" onclick="deleteFile(\'' + names[0].trim() + '\')" > 删除</a>'
                document.getElementById("bffiles").appendChild(li);
                $("#bfup").val("");
            });
        })
    })
    function bidSubmit(ss) {
        var adate = $("#applydate").val()
        var odate = $("#opendate").val()
        var bnum = $("#bidingnum").val()
        if(adate==""){
            swal("请输入报名截止时间！")
            return;
        }
        if(odate==""){
            swal("请输入预计开标时间！")
            return;
        }
        if(bnum==""){
            swal("请输入拟中标单位数量！")
            return;
        }
        var pid =@ViewBag.pid;
        data = { adate: adate, odate: odate, bnum: bnum, pid: pid, status: ss }
        $.post("/Projects/ReapplyBid", data, function (res) {
            $("#bidapplylayer").hide();
            swal('提交成功！')
            window.location.href = "/Projects/Detail?pid="+pid;

        })
    }

    function deleteFile(name) {
        var li = document.getElementById(name)
        li.parentNode.removeChild(li);
        $.post("/Common/FileDelete", { fname: name }, function () {});
    }

    $(".canvas_close").on("click", function () {
        $("#bidfileapplylayer").hide();
        $("#bfcontent").val("");
        $(".canvas").hide();
        $(".textinfo").css("display","none")
    })
    $(".gray-btn").on("click", function () {
        $("#bidfileapplylayer").hide();
        $("#bfcontent").val("");
        $(".canvas").hide();
        $(".textinfo").css("display","none")
    })
    $(".backcolse-btn").on("click", function () {
        $("#bidfileapplylayer").hide();
        $("#bfcontent").val("");
        $(".canvas").hide();
        $(".textinfo").css("display","none")
    })


    function bidApply() {
        $("#bidapplylayer").show();
        $.get("/Projects/GetBidInfo?pid=@ViewBag.pid", function (data) {
            var obj = JSON.parse(data);
            $("#applydate").val(obj[0].applydate)
            $("#opendate").val(obj[0].opendate)
            $("#bidingnum").val(obj[0].bidingnum)
        });

    }

</script>
