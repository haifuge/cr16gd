@{
    ViewBag.Title = "系统设置";
}

<link rel="stylesheet" href="~/css/icheck/minimal/minimal.css" />

<link href="~/css/sweetalert2.css" rel="stylesheet" />
<link rel='stylesheet' href='~/js/ztree/css/zTreeStyle/zTreeStyle.css' />
<link rel="stylesheet" href="~/css/style.css" />

<style>
    html, body {
        width: 100%;
        height: 100%;
    }

    * {
        padding: 0;
        margin: 0;
    }

    table.meet-table {
        border: none;
    }

    .meet-table tr {
        border-bottom: none;
    }

        .meet-table tr.white-bg td {
            border: none;
        }

    * {
        margin: 0;
        position: 0;
    }

    ul li {
        list-style: none;
    }

    .block-left {
        padding-right: 0;
    }

    .meet-form.meet-form9.meet-form3 .form-tr:hover {
        background: #eaf6fd;
    }

    .canvas {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, .6);
        z-index: 9999;
        display: none;
    }

        .canvas .canvas_content {
            width: 500px;
            height: 300px;
            background: #fff;
            position: relative;
            top: 100px;
            left: 0;
            bottom: 0;
            right: 0;
            margin: auto;
            border: 1px solid #008cd6;
        }

        .canvas h3 {
            height: 45px;
            padding-left: 20px;
            background: #eaf6fd;
            line-height: 45px;
            font-size: 18px;
            font-weight: normal;
            color: #008cd6;
        }

        .canvas .canvas_close {
            display: inline-block;
            width: 35px;
            height: 35px;
            font-size: 30px;
            color: #008cd6;
            top: 0;
            text-align: center;
            cursor: pointer;
            position: absolute;
            right: 10px;
        }

    .canvas_content_text {
        width: 100%;
        height: 50%;
        margin-top: 35px;
    }

        .canvas_content_text ul li {
            padding: 5px 10px;
            margin-left: 40px;
            color: #999;
            position: relative;
        }

            .canvas_content_text ul li ul li {
                margin-left: 90px;
            }

            .canvas_content_text ul li textarea {
                height: 185px;
                border-radius: 5px;
                border: 1px solid #d7d7d7;
                width: 585px;
                resize: none;
                margin-left: 10px;
                padding: 10px;
                line-height: 20px;
                text-align: justify;
            }

            .canvas_content_text ul li input[type="text"] {
                -web-kit-appearance: none;
                -moz-appearance: none;
                width: 120px;
                height: 25px;
                border: 1px solid #c8cccf;
                border-radius: 5px;
                color: #6a6f77;
                outline: 0;
                padding-left: 5px;
            }

                .canvas_content_text ul li input[type="text"].input3 {
                    width: 50px;
                }

            .canvas_content_text ul li i {
                color: #ff0000;
                line-height: 25px;
                padding-right: 5px;
                vertical-align: middle;
                display: inline-block;
                font-style: normal;
            }

            .canvas_content_text ul li span {
                display: inline-block;
                width: 80px;
                text-align: left;
                float: left;
            }

            .canvas_content_text ul li .upload {
                position: relative;
                display: inline-block;
                text-align: center;
                color: #ffffff;
                width: 70px;
                height: 30px;
                line-height: 30px;
                background-color: #008bd6;
                border-radius: 3px;
            }

                .canvas_content_text ul li .upload input[type="text"] {
                    opacity: 0;
                    position: absolute;
                    left: 0;
                }

    .canvas_btn {
        text-align: center;
        padding-top: 100px;
    }

    .canvas-fj {
        padding-left: 5px;
        display: inline-block;
        font-size: 14px;
        color: #bfbdba;
    }

    .meet-form2 .form-tr-btn {
        text-align: center;
    }

    .form-tr td span {
        color: #ff7412;
        font-size: 13px;
    }
</style>
<div class="left-nav">
    <div class="left-nav-con">
        <h1>系统设置</h1>
        <ul class="left-nav-list">
            <li><a href="SystemSetup" class="active"><i class="icon icon-eye1"></i>组织结构</a></li>
            <li><a href="SystemSetup/PersonalCenter"><i class="icon icon-hand2"></i>个人中心</a></li>
            <li><a href="SystemSetup/SystemLog"><i class="icon icon-hand3"></i>系统日志</a></li>
            <li><a href="SystemSetup/CategoryManagement"><i class="icon icon-hand4"></i>类别管理</a></li>
            <li><a href="SystemSetup/SystemUser"><i class="icon icon-hand5"></i>系统用户</a></li>
            <li><a href="SystemSetup/ApproveProcessManagement"><i class="icon icon-hand4"></i>审核流程</a></li>
        </ul>
    </div>
</div>
<div class="main-con">
    <div class="main-wrap">
        <div class="main-top">
            <!--<a class="meet-btn blue-btn sm-btn" href="#">全部</a>-->
            <div class="search-con2" style="margin-right: 15px;">
                <input type="text" name="keyname" placeholder="请输入关键字">
                <a class="search-btn" style="background: none"></a>
            </div>
            <a class="meet-btn blue-btn sm-btn" href="#">搜索</a>
            <div class="apply-opt">
                <a href="#" class="js-cancle-meet" title="">
                    <i class="meet-icon icon-cancel iconc add-img" style="">添加人员</i>
                </a>
            </div>
        </div>
                <!-- 修改用户信息 -->
                <div class="canvas canvas3">
                    <div class="canvas_content">
                        <span class="canvas_close canvas_close3">×</span>
                        <h3>修改用户信息</h3>
                        <div class="wc-container">
                            <table class="meet-form meet-form2 meet-form5">
                                <tbody>
                                    <tr class="form-tr">
                                        <td class="form-lable">部门：</td>
                                        <td>
                                            <div class="form-item  sel-required">
                                                <input name="roomInfoName" type="text" value="" id="xgaddpeo"
                                                       class="has-clear-input input input3 addbumen" disabled />
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">账号：</td>
                                        <td>
                                            <input name="roomInfoName" type="text" value="" id="xguaccount"
                                                   class="has-clear-input input input3  " onblur="yzzh('xguaccount', 'xgd1')"  disabled/>
                                            <span id="xgd1"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">姓名：</td>
                                        <td>
                                            <input name="roomInfoName" type="text" value="" id="xguname" 
                                                   class="has-clear-input input input3  " onBlur="yzxm('xguname', 'xgxm')" />
                                            <span id="xgxm"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">手机：</td>
                                        <td>
                                            <input name="roomInfoName" type="text" value="" id="xgutel"
                                                   class="has-clear-input input  input3  " onBlur="checkphone('xgutel', 'xgphonemsg')" />
                                            <span id="xgphonemsg"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">邮箱：</td>
                                        <td>
                                            <input type="email" name="roomInfoName" value="" id="xguemail" 
                                                   class="has-clear-input input  input3 " onBlur="checkmail('xguemail', 'xgmailmess')" />
                                            <span id="xgmailmess"></span>
                                        </td>
                                    </tr>
                                </tbody>

                            </table>
                            <div class="form-tr-btn">
                                <button type="submit" class="meet-btn big-btn lightblue-btn js-submit" onclick="xgUser()">确定</button>
                                <button type="reset" class="meet-btn big-btn gray-btn canvas_close3">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 添加人员 -->
                <div class="canvas canvas1">
                    <div class="canvas_content">
                        <span class="canvas_close canvas_close1">×</span>
                        <h3>添加人员</h3>
                        <div class="wc-container">

                            <table class="meet-form meet-form2 meet-form5">
                                <tbody>
                                    <tr class="form-tr">
                                        <td class="form-lable">部门：</td>
                                        <td>
                                            <div class="form-item  sel-required">
                                                <input name="roomInfoName" type="text" value="" id="addpeo"
                                                       class="has-clear-input input input3 addbumen" disabled />
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">账号：</td>
                                        <td>
                                            <input name="roomInfoName" type="text" value="" id="uaccount"
                                                   class="has-clear-input input input3 " onblur="yzzh('uaccount','d1')"  />
                                            <span id="d1"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">输入密码：</td>
                                        <td>
                                            <input type="password" name="roomInfoName" value="" id="upsd"
                                                   class="has-clear-input input input3 " onBlur="checkpwd('upsd', 'pwdmsg')" />
                                            <span id="pwdmsg"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">确认密码：</td>
                                        <td>
                                            <input type="password" name="roomInfoName" value=""
                                                   class="has-clear-input input input3 " id="repwd" onBlur="checkrepwd('repwd','repwdmsg')" />
                                            <span id="repwdmsg"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">姓名：</td>
                                        <td>
                                            <input name="roomInfoName" type="text" value="" id="uname"
                                                   class="has-clear-input input input3  " onBlur="yzxm('uname', 'xm')" />
                                            <span id="xm"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">手机：</td>
                                        <td>
                                            <input name="roomInfoName" type="text" value="" id="utel"
                                                   class="has-clear-input input  input3 " onBlur="checkphone('utel', 'phonemsg')" />
                                            <span id="phonemsg"></span>
                                        </td>
                                    </tr>
                                    <tr class="form-tr">
                                        <td class="form-lable">邮箱：</td>
                                        <td>
                                            <input type="email" name="roomInfoName" value="" id="uemail"
                                                   class="has-clear-input input  input3 " onBlur="checkmail('uemail', 'mailmess')" />
                                            <span id="mailmess"></span>
                                        </td>
                                    </tr>

                                </tbody>
                                
                            </table>
                            <div class="form-tr-btn">
                                <button type="submit" class="meet-btn big-btn lightblue-btn js-submit" onclick="createNewUser()">确定</button>
                                <button type="reset" class="meet-btn big-btn gray-btn canvas_close1">取消</button>
                            </div>

                        </div>
                    </div>
                </div>
            
       
        <div class="wc-container szwc-container" style="border: 1px solid #ececec;overflow: hidden">
            <div class="dc-left">
                <h3>
                    组织机构信息 <a href="#" class="meet-icon icon-cancel iconc iconc2  add-img2">添加部门</a>
                </h3>
                <!-- 添加部门 -->
                <div class="canvas canvas2">
                    <div class="canvas_content">
                        <span class="canvas_close canvas_close2">×</span>
                        <h3>添加部门</h3>
                        <div class="wc-container">
                          
                                <table class="meet-form meet-form2 meet-form5">
                                    <tbody>
                                        <tr class="form-tr">
                                            <td class="form-lable">上级部门：</td>
                                            <td>
                                                <input name="roomInfoName" type="text" value=""
                                                       class="has-clear-input input input3 addbumen" disabled />
                                                <input type="checkbox" id="addbox1" name="" class="addbox" />
                                                <label for='addbox1' class="addbox1ab">是否创建新节点</label>
                                            </td>
                                        </tr>
                                        <tr class="form-tr">
                                            <td class="form-lable">部门名称：</td>
                                            <td>
                                                <input name="roomInfoName" type="text" value="" id="dname"
                                                       class="has-clear-input input input3" />
                                            </td>
                                        </tr>
                                        <tr class="form-tr">
                                            <td class="form-lable">审批级别：</td>
                                            <td>
                                                <input name="roomInfoName" type="text" value="" id="dlevel"
                                                       class="has-clear-input input input3 addlevel" disabled />
                                            </td>
                                        </tr>
                                    </tbody>
                                    
                                </table>
                            <div class="form-tr-btn">
                                <button type="submit" class="meet-btn big-btn lightblue-btn js-submit" onclick="createDepartment();return false;">确定</button>
                                <button type="reset" class="meet-btn big-btn gray-btn canvas_close2">取消</button>
                            </div>
                                
                            
                        </div>
                    </div>
                </div>
                <div class="content_wrap">
                    <div class="zTreeDemoBackground left">
                        <ul id="tree" class="ztree"></ul>
                    </div>
                </div>
            </div>
            <div class="dc-right">
                <table class="meet-table text-left">
                    <thead class="wc-header">
                        <tr>
                    <td class="check-color">
                        用户名
                    </td>
                    <td>姓名</td>
                    <td>部门</td>
                    <td>手机</td>
                    <td>邮箱</td>
                    <td>操作</td>
                    </tr>
                    </thead>
                    <tbody id="tbusers"></tbody>
                </table>
                <div class="page" >
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="~/js/jquery-1.11.0.js"></script>
<script type="text/javascript" src="~/js/jquery-ui.min.js"></script>
<script type="text/javascript"  src="~/js/sweetalert2.all.js"></script>
<script type="text/javascript" src="~/js/validate/jquery.validate.min.js"></script>
<script type="text/javascript" src="~/js/validate/messages_zh.min.js"></script>
<script type="text/javascript" src="~/js/icheck/icheck.min.js"></script>
<script type="text/javascript" src="~/js/js.js"></script>
<script src="~/js/ztree/js/jquery.ztree.core.js"></script>
<script src="~/js/ztree/js/jquery.ztree.exedit.js"></script>
<script type="text/javascript" src="~/js/ztree/js/jquery.ztree.excheck.js"></script>

<script type="text/javascript">
    $(function () {
        pages(1, 2, 12, 5)
    })
    var setting = {
        view: {
            addHoverDom: addHoverDom,
            removeHoverDom: removeHoverDom,
            selectedMulti: false
        },
        //check: {
        //    enable: true
        //},
        data: {
            simpleData: {
                enable: true
            }
        },
        edit: {
            enable: true,
            editNameSelectAll: true,
            //showRenameBtn: showRenameBtn,
            //showRemoveBtn: showRemoveBtn,
            //showRenameBtn: showRenameBtn
        },
        callback: {
            onClick: zTreeOnClick, //单击事件
            onRemove: onRemove, //移除事件
            onRename: onRename, //修改事件
            beforeRename: beforeRename,
            beforeRemove: beforeRemove
        }
    };

    var zNodes = [
        {
            id: 1, pId: 0, name: "中国铁建地产集团", open: true, checked: true, icon: "", iconOpen: "/img/icon-fopen.png", iconClose: "/img/icon-fclose.png"
        },
        { id: 11, pId: 1, name: "开发测试", open: true, icon: "/img/icon-fclose.png", iconOpen: "/img/icon-fopen.png", iconClose: "/img/icon-fclose.png" },
        { id: 111, pId: 11, name: "董事会", icon: "/img/icon-fclose.png", iconOpen: "/img/icon-fopen.png", iconClose: "/img/icon-fclose.png" },
        { id: 112, pId: 12, name: "总经理", icon: "/img/icon-fclose.png", iconOpen: "/img/icon-fopen.png", iconClose: "/img/icon-fclose.png" },
        { id: 12, pId: 1, name: "集团总部", open: true, icon: "", iconOpen: "/img/icon-fopen.png", iconClose: "/img/icon-fclose.png" },
        { id: 121, pId: 12, name: "董事会", icon: "/img/icon-fclose.png", iconOpen: "/img/icon-fopen.png", iconClose: "/img/icon-fclose.png" },
        { id: 122, pId: 12, name: "总经理", icon: "/img/icon-fclose.png", iconOpen: "/img/icon-fopen.png", iconClose: "/img/icon-fclose.png" },
        { id: 2, pId: 0, name: "集团总部", open: true },
        { id: 21, pId: 2, name: "公司领导" },
        { id: 22, pId: 2, name: "总经理办公室", open: true },
        { id: 221, pId: 22, name: "董事会" },
        { id: 222, pId: 22, name: "总经理办公室", icon: "/img/icon-fclose.png" }
    ];
    var nodes;
    function initTree() {
        $.get("/SystemSetup/GetOrganizations", {}, function (data) {
            //console.log(data)
            data = data.replace(/pid/g, 'pId').replace(/iconclose/g, 'iconClose').replace(/iconopen/g, 'iconOpen')
            nodes = JSON.parse(data);
            $.fn.zTree.init($("#tree"), setting, nodes);
        })
    }
    $(document).ready(function () {
        initTree();
    });
    var cNode;
    var cNodename;
    var cNodelevel;
    function zTreeOnClick(event, treeId, treeNode) {
        cNode = treeNode;
        cNodename = cNode.name;
        cNodelevel = getDepartmentLevel(cNode.id) + 1;
        console.log(cNodelevel);
        $(".addlevel").val(cNodelevel);
        $(".addbumen").val(cNode.name);
        getDepartmentUsers();
    }
    function getDepartmentLevel(id) {
        for (var i = 0; i < nodes.length; i++) {
            if (id == nodes[i].id)
                return nodes[i].level;
        }
    }
    $(".addbox").click(function () {
        if ($(this).is(":checked")) {
            $(".addbox").prop("checked", true);
            $(".addbumen").val("");
            $(".addlevel").val("");
            $(".addlevel").attr("disabled", false);

        } else {
            $(".addbox").prop("checked", false);
            $(".addbumen").val(cNodename);
            $(".addlevel").val(cNodelevel);
            $(".addlevel").attr("disabled", "disabled");


        }
    });

    var newCount = 1;

    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span"); //获取节点信息
        if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0) return;
        var addStr = "<span class='button add' id='addBtn_" + treeNode.tId + "' title='add node' onfocus='this.blur();'></span>"; //定义添加按钮
        sObj.after(addStr); //加载添加按钮
        //var btn = $("#addBtn_" + treeNode.tId);
        //var lev=treeNode.level+1
        ////绑定添加事件，并定义添加操作
        //if (btn) btn.bind("click", function () {
        //    var zTree = $.fn.zTree.getZTreeObj("tree");
        //    //将新节点添加到数据库中
        //    var name = 'NewNode';
        //    $.post('/SystemSetup/AddDepartment?pid=' + treeNode.id + '&level=' + lev, function (data) {
        //        var newID = data; //获取新添加的节点Id
        //        zTree.addNodes(treeNode, { id: newID, pId: treeNode.id, name: name, level: lev }); //页面上添加节点
        //        var node = zTree.getNodeByParam("id", newID, null); //根据新的id找到新添加的节点
        //        zTree.selectNode(node); //让新添加的节点处于选中状态
        //    });
        //});
    };
    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_" + treeNode.tId).unbind().remove();
    };
    function onRename(e, treeId, treeNode, isCancel) {
        //需要对名字做判定的，可以来这里写~~
        $.post('/SystemSetup/UpdateDepartment?id=' + treeNode.id + '&name=' + treeNode.name);
    }
    function beforeRename(treeId, treeNode, newName, isCancel) {
        if (newName.length == 0) {
            swal('部门名称不能为空');
            return false;
        }
        return true;
    }
    function onRemove(e, treeId, treeNode) {
        $.post('/SystemSetup/RemoveDepartment?id=' + treeNode.id);
    }
    function beforeRemove(treeId, treeNode) {
        var zTree = $.fn.zTree.getZTreeObj("tree");
        zTree.selectNode(treeNode);
        if (hasChildren(treeNode)) {
            swal('当前部门有下级部门，请删除下级部门后，再删除该部门')
            return false;
        }

        return confirm("确认删除 节点 -- " + treeNode.name + " 吗？");
    }
    $(".add-img").on("click", function () {
        var addpeo = document.getElementById('addpeo').value;
        if (addpeo = null || addpeo == "") {
            swal("请选择部门");
        } else {
            $(".canvas.canvas1").show();
        }
    })
    $(".canvas_close1").on("click", function () {
        $(".canvas.canvas1").hide();
        $("#xm").html("");
        $("#d1").html("");
        $("#pwdmsg").html("");    
        $("#repwdmsg").html("");
        $("#phonemsg").html("");
        $("#mailmess").html("");
        $("#uaccount").val("");
        $("#upsd").val("");
        $("#uname").val("");
        $("#utel").val("");
        $("#uemail").val("");
        $("#repwd").val("")
    })
    $(".canvas_close3").on("click", function () {
        $(".canvas.canvas3").hide();
        
    })
    function createDepartment() {
        $(".canvas.canvas2").hide();
        var pid
        if (cNode == null) {
            pid = 0
        } else {
            pid = cNode.id;
        }
        if ($(".addbox").is(":checked"))
            pid = 0;
        var depname = $.trim($("#dname").val());
        var depLevel = $("#dlevel").val();
        if (depLevel == "") {
            swal('请输入审批级别')
            $("#dlevel").focus();
            return;
        }
        $.post("/SystemSetup/AddDepartment", { pid: pid, dname: depname, dl: depLevel }, function (nid) {
            console.log(nid)
            if (nid != "0") {
                initTree();
                var zTree = $.fn.zTree.getZTreeObj("tree");
                var node = zTree.getNodeByParam("id", parseInt(nid), null); //根据新的id找到新添加的节点
                console.log(node)
                zTree.selectNode(node); //让新添加的节点处于选中状态
                zTree.expandNode(node, true, false, true);
            }
        });
    }
    // 添加部门
    $(".add-img2").on("click", function () {
            $(".canvas.canvas2").show();
        
    })
    function getChildNodes(treeNode) {
        var naviTree = $.fn.zTree.getZTreeObj("tree");
        var childNodes = naviTree.transformToArray(treeNode);
        var nodes = new Array();
        for (i = 0; i < childNodes.length; i++) {
            nodes[i] = childNodes[i].id;
        }
        return nodes.join(",");
    }
    function hasChildren(treeNode) {
        var naviTree = $.fn.zTree.getZTreeObj("tree");
        var childNodes = naviTree.transformToArray(treeNode);
        if (childNodes.length > 2)
            return true;
        return false;
    }
    $(".canvas_close2").on("click", function () {
        $(".canvas.canvas2").hide();
        $(".addbumen").val("");
        $("#dname").val("");
        $("#dlevel").val("");
        
        if ($(".addbox").is(":checked")) {
            $(".addbox").prop("checked", false);
        }
        $(".addlevel").attr("disabled", "disabled");
    })
    
   

    //添加人员
    function createNewUser() {
        var success = 0;
        success += yzzh('uaccount', 'd1'); 
        success += yzxm('uname', 'xm');
        success += checkphone('utel', 'phonemsg');
        success += checkpwd('upsd', 'pwdmsg');
        success += checkrepwd('repwd', 'repwdmsg');
        success += checkmail('uemail', 'mailmess');
        if (success > 0) {
            return;
        }

        var account = $("#uaccount").val();
        var password = $("#upsd").val();
        var name = $("#uname").val();
        var tel = $("#utel").val();
        var email = $("#uemail").val();
        var depId = cNode.id;
        var data = { acc: account, pasd: password, nam: name, telephone: tel, em: email, did: depId };
        $.post("/SystemSetup/CreateUser", data, function (res) {
            if (res == "1") {
                swal(
                  '创建成功！',
                  '您已成功创建一个用户',
                  'success'
                );
                $("#xm").html("");
                $("#d1").html("");
                $("#pwdmsg").html("");
                $("#repwdmsg").html("");
                $("#phonemsg").html("");
                $("#mailmess").html("");
                $(".canvas.canvas1").hide();
                getDepartmentUsers();
                $("#uaccount").val("");
                $("#upsd").val("");
                $("#uname").val("");
                $("#utel").val("");
                $("#uemail").val("");
                $("#repwd").val("");
            }
            else {
                swal({
                    title: '创建失败！',
                    text: '2秒后自动关闭。',
                    timer: 2000
                }).then(
                    function () { },
                    // handling the promise rejection
                    function (dismiss) {
                        if (dismiss === 'timer') {
                            console.log('I was closed by the timer')
                        }
                    }
                )
                $("#uaccount").val("");
                $("#upsd").val("");
                $("#uname").val("");
                $("#utel").val("");
                $("#uemail").val("");
                $("#repwd").val("");
            }
        })
    }
    var users;
    function getDepartmentUsers() {
        $.post("/SystemSetup/GetDepartmentUsers", { did: cNode.id }, function (res) {
            var obj = JSON.parse(res);
            $("#tbusers").empty();
            var htm = "";
            users = obj;
            for (var i = 0; i < obj.length; i++) {
                var o = obj[i]
                htm += '<tr class="white-bg" id="utr'+o.id+'"><td class="check-color">' + o.useraccount + '</td>' +
                    '<td>' + o.username + '</td>' +
                    '<td>' + o.department + '</td>' +
                    '<td>' + o.telephone + '</td>' +
                    '<td>' + o.email + '</td>' +
                    '<td style="width: 100px;"><a href="#" class="xg" style="display: inline-block" onclick="updateUser(' + o.id + ')">修改</a>&nbsp;&nbsp;<a href="#" class="xg" style="display: inline-block" onclick="deleteUser(' + o.id + ')">删除</a></td>' +
                    '</tr >';
            }
            $("#tbusers").html(htm)
        })
    }
    /*删除用户*/
    function deleteUser(id) {
        swal({
            title: '确定删除该用户吗？',
            text: '你将无法恢复它！',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '确定删除！'
        }).then(
        function (cc) {
            if (cc.dismiss != "cancel"){
                $.post("/SystemSetup/DeleteUser", { uid: id }, function () {
                    swal(
                  '删除！',
                  '该用户已经被删除。',
                  'success'
                    );
                    var otr = document.getElementById('utr' + id);
                    otr.parentNode.removeChild(otr);
                    getDepartmentUsers()
                }
               )
            }
        }
    )
    }
    /*修改用户弹框*/
    function updateUser(id) {
        $(".canvas.canvas3").show();
        for (var i = 0; i < users.length; i++) {
            var o = users[i];
            if(o.id==id){
                $('#xguaccount').val(o.useraccount);
                $('#xguname').val(o.username);
                $('#xgutel').val(o.telephone);
                $('#xguemail').val(o.email);
                break;
            }
        }
    }
    /*修改用户信息*/
    function xgUser() {
        var success = 0; 
        success += yzxm('xguname', 'xgxm');
        success += checkphone('xgutel', 'xgphonemsg');
        success += checkmail('xguemail', 'xgmailmess');
        if (success > 0) {
            return;
        }


        var xguaccount = $('#xguaccount').val();
        var xguname = $('#xguname').val();
        var xgutel = $('#xgutel').val();
        var xguemail = $('#xguemail').val();
        var obj = { uname: xguname, tel: xgutel, em: xguemail, account: xguaccount }
        $.post("/SystemSetup/UpdateUserInfo", obj, function (res) {
            if (res = "1"){
                swal(
                  '修改成功！',
                  '您已成功修改用户信息',
                  'success'
                );
                getDepartmentUsers()
            }
            else

                swal({
                    title: '修改失败！',
                    text: '2秒后自动关闭。',
                    timer: 2000
                }).then(
                 function () { },
                  // handling the promise rejection
                 function (dismiss) {
                 if (dismiss === 'timer') {
                       console.log('I was closed by the timer')
                       }
                     }
               )
        })
        $(".canvas.canvas3").hide();
    }

    /*验证*/
    function yzzh(elementName, wid) {
        var _uaccount = document.getElementById(elementName).value;
        if (_uaccount = null || _uaccount == "") {
            document.getElementById(wid).innerHTML = "×用户名不能为空"
            return 1;
        } else {
            document.getElementById(wid).innerHTML = "√";
            return 0;
        }
    }

    function yzxm(elementName, wid) {
        var _uname = document.getElementById(elementName).value;
        if (_uname = null || _uname == "") {
            document.getElementById(wid).innerHTML = "×姓名不能为空";
            return 1;
        } else {
            document.getElementById(wid).innerHTML = "√";
            return 0;
        }
    }

    function checkphone(elementName, wid) {
        var reg = /^1\d{10}$/;
        var _phone = document.getElementById(elementName).value;
       
        if (reg.test(_phone)) {
            document.getElementById(wid).innerHTML = "√";
            return 0;
        } else {
            document.getElementById(wid).innerHTML = "×电话格式不对";
            return 1;
        }
    }
    function checkpwd(elementName, wid) {
        var reg = /.{6,}/;
        var _pwd = document.getElementById(elementName).value;
        if (reg.test(_pwd)) {
            document.getElementById(wid).innerHTML = "√";
            return 0;
        } else {
            document.getElementById(wid).innerHTML = "×请输入6位密码";
            return 1;
        }
    }
    function checkrepwd(elementName, wid) {
        var _pwd = document.getElementById('upsd').value;
        var _repwd = document.getElementById(elementName).value;

        if (_pwd != _repwd || _pwd == "") {
            document.getElementById(wid).innerHTML = "×密码不一致";
            return 1;
        } else {
            document.getElementById(wid).innerHTML = "√";
            return 0;
        }
    }


    function checkmail(elementName, wid) {

        var mail = document.getElementById(elementName).value;
        if (mail = null || mail == "") {
            document.getElementById(wid).innerHTML = "×邮箱不能为空";
            return 1;
        }
        else {
            document.getElementById(wid).innerHTML = "√";
            return 0;
        }
    }

</script>